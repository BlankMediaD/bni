<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Tracker Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jQuery is a dependency for DataTables -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- DataTables JS and CSS -->
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.tailwindcss.min.js"></script>
    <link href="https://cdn.datatables.net/2.0.8/css/dataTables.tailwindcss.min.css" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .modal, .loader-overlay { display: none; }
        .modal.active, .loader-overlay.active { display: flex; }
        .chart-container { position: relative; height: 40vh; width: 100%; }
        /* Style for DataTables search box */
        div.dt-container .dt-search input {
            width: 100% !important;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
        }

        @media (max-width: 640px) {
            .tab-link {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
            .tab-link.border-blue-500 {
                border-bottom-width: 4px;
            }
            .container {
                padding: 1rem;
            }
            h1 {
                font-size: 1.875rem;
            }
            .grid-cols-1.md\:grid-cols-2.lg\:grid-cols-5 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Loading Overlay -->
    <div id="loader" class="loader-overlay fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="text-white text-xl font-semibold">Loading Data...</div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Community Payment Tracker</h1>
            <p class="text-md text-gray-600 mt-2">Manage and track payments, expenses, and reports seamlessly.</p>
        </header>

        <!-- Tabs -->
        <div class="mb-8">
            <div class="flex flex-wrap border-b border-gray-300">
                <button class="tab-link py-2 px-4 -mb-px bg-white border-b-2 border-blue-500 text-blue-600 font-semibold rounded-t-lg" onclick="openTab(event, 'dashboard-tab')">Dashboard</button>
                <button class="tab-link py-2 px-4 text-gray-500 hover:text-blue-600 font-semibold" onclick="openTab(event, 'reports-tab')">Reports</button>
                <button class="tab-link py-2 px-4 text-gray-500 hover:text-blue-600 font-semibold" onclick="openTab(event, 'form-tab')">Submit Payment</button>
                <button class="tab-link py-2 px-4 text-gray-500 hover:text-blue-600 font-semibold" onclick="openTab(event, 'members-tab')">Members</button>
                <button class="tab-link py-2 px-4 text-gray-500 hover:text-blue-600 font-semibold" onclick="openTab(event, 'monthly-payments-tab')">Monthly Log</button>
                <button class="tab-link py-2 px-4 text-gray-500 hover:text-blue-600 font-semibold" onclick="openTab(event, 'extra-payments-tab')">Extra Payments Log</button>
                <button class="tab-link py-2 px-4 text-gray-500 hover:text-blue-600 font-semibold" onclick="openTab(event, 'expenses-tab')">Expenses Log</button>
            </div>
            <div class="flex flex-wrap border-b border-gray-300 mt-2">
                <button class="tab-link py-2 px-4 text-gray-500 hover:text-blue-600 font-semibold" onclick="openTab(event, 'admin-tab')">Admin Panel</button>
                <button class="tab-link py-2 px-4 text-gray-500 hover:text-blue-600 font-semibold" onclick="openTab(event, 'extra-events-tab')">Extra Events</button>
                <button class="tab-link py-2 px-4 text-gray-500 hover:text-blue-600 font-semibold" onclick="openTab(event, 'settings-tab')">Settings</button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md text-center"><h3 class="text-lg font-semibold text-gray-600">Total Members</h3><p id="total-members" class="text-3xl font-bold text-blue-600 mt-2">0</p></div>
                <div class="bg-white p-6 rounded-lg shadow-md text-center"><h3 class="text-lg font-semibold text-gray-600">Total Collected</h3><p id="total-collected" class="text-3xl font-bold text-green-600 mt-2">₹0</p></div>
                <div class="bg-white p-6 rounded-lg shadow-md text-center"><h3 class="text-lg font-semibold text-gray-600">Total Due</h3><p id="total-due" class="text-3xl font-bold text-red-600 mt-2">₹0</p></div>
                <div class="bg-white p-6 rounded-lg shadow-md text-center"><h3 class="text-lg font-semibold text-gray-600">June Pending</h3><p id="june-pending" class="text-3xl font-bold text-orange-500 mt-2">₹0</p></div>
                <div class="bg-white p-6 rounded-lg shadow-md text-center"><h3 class="text-lg font-semibold text-gray-600">July Pending</h3><p id="july-pending" class="text-3xl font-bold text-yellow-500 mt-2">₹0</p></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Monthly Collection Status</h2>
                    <div class="chart-container"><canvas id="monthly-collection-chart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">This Month's Expenses</h2>
                    <div id="monthly-expenses-list" class="space-y-3 overflow-y-auto h-80"></div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4">Month-wise Payment Report</h2>
                <div class="mb-4">
                    <label for="report-month-filter" class="block text-sm font-medium text-gray-700">Select Month</label>
                    <select id="report-month-filter" class="mt-1 block w-full md:w-1/3 p-2 border border-gray-300 rounded-md">
                    </select>
                </div>
                <div id="report-container" class="overflow-x-auto">
                     <table id="report-table" class="w-full"></table>
                </div>
            </div>
        </div>

        <!-- Form Tab -->
        <div id="form-tab" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-center">New Payment</h2>
                <form id="payment-form">
                    <div class="mb-4">
                        <label for="payment-type" class="block text-sm font-medium text-gray-700 mb-1">Payment Type</label>
                        <select id="payment-type" name="payment-type" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select Payment Type</option><option value="monthly">Monthly Payment</option><option value="extra">Extra Payment</option>
                        </select>
                    </div>
                    <div id="monthly-payment-fields" class="hidden space-y-4">
                        <div><label for="monthly-member-name" class="block text-sm font-medium text-gray-700 mb-1">Member Name</label><select id="monthly-member-name" class="w-full p-2 border border-gray-300 rounded-md"></select></div>
                        <div><label for="month" class="block text-sm font-medium text-gray-700 mb-1">Month</label><select id="month" class="w-full p-2 border border-gray-300 rounded-md"></select></div>
                        <div id="monthly-payment-history" class="text-sm text-gray-600 bg-gray-50 p-3 rounded-md hidden"></div>
                        <div><label for="monthly-amount-paid" class="block text-sm font-medium text-gray-700 mb-1">Amount Paid (INR)</label><input type="number" id="monthly-amount-paid" class="w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., 1500"></div>
                        <div><label for="paid-via" class="block text-sm font-medium text-gray-700 mb-1">Paid Via</label><select id="paid-via" class="w-full p-2 border border-gray-300 rounded-md"><option value="UPI">UPI</option><option value="Cash">Cash</option><option value="Card">Card</option></select></div>
                    </div>
                    <div id="extra-payment-fields" class="hidden space-y-4">
                        <div><label for="extra-member-name" class="block text-sm font-medium text-gray-700 mb-1">Member Name</label><select id="extra-member-name" class="w-full p-2 border border-gray-300 rounded-md"></select></div>
                        <div><label for="extra-payment-for" class="block text-sm font-medium text-gray-700 mb-1">Extra Payment For</label><select id="extra-payment-for" class="w-full p-2 border border-gray-300 rounded-md"></select></div>
                        <div id="extra-payment-history" class="text-sm text-gray-600 bg-gray-50 p-3 rounded-md hidden"></div>
                        <div><label for="extra-amount-paid" class="block text-sm font-medium text-gray-700 mb-1">Amount Paid (INR)</label><input type="number" id="extra-amount-paid" class="w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., 500"></div>
                    </div>
                    <div class="mt-6"><button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Submit Payment</button></div>
                </form>
            </div>
        </div>

        <!-- Admin Panel Tab -->
        <div id="admin-tab" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow-md max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1">
                    <h2 class="text-2xl font-bold mb-4">Manage Members</h2>
                    <div><h3 class="text-lg font-semibold mb-2">Existing Members</h3><div id="member-list" class="space-y-2 max-h-96 overflow-y-auto"></div></div>
                </div>
                <div class="lg:col-span-1">
                    <h2 class="text-2xl font-bold mb-4">Manage Expenses</h2>
                    <div><h3 class="text-lg font-semibold mb-2">Add Expense</h3><form id="add-expense-form" class="space-y-4"><div><label for="expense-name" class="block text-sm font-medium text-gray-700">Expense Name</label><input type="text" id="expense-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></div><div><label for="expense-amount" class="block text-sm font-medium text-gray-700">Amount (INR)</label><input type="number" id="expense-amount" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></div><div><label for="expense-date" class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="expense-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></div><div><label for="expense-comment" class="block text-sm font-medium text-gray-700">Comment</label><textarea id="expense-comment" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea></div><button type="submit" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">Add Expense</button></form></div>
                </div>
                <div class="lg:col-span-1">
                    <h2 class="text-2xl font-bold mb-4">Manage Monthly Fees</h2>
                    <form id="monthly-fees-form"><div id="monthly-fees-list" class="space-y-2"></div><button type="submit" class="w-full mt-4 bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700">Save All Monthly Fees</button></form>
                </div>
            </div>
        </div>

        <!-- Extra Events Tab -->
        <div id="extra-events-tab" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-center">Manage Extra Events</h2>
                <div class="mb-6"><h3 class="text-lg font-semibold mb-2">Add New Event</h3><form id="admin-event-form" class="space-y-4"><div><label for="event-name" class="block text-sm font-medium text-gray-700">Event Name</label><input type="text" id="event-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., Annual Picnic"></div><div><label for="event-amount" class="block text-sm font-medium text-gray-700">Amount Due (INR)</label><input type="number" id="event-amount" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., 2000"></div><button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Add Event</button></form></div>
                <div><h3 class="text-lg font-semibold mb-2">Existing Events</h3><div id="event-list" class="space-y-2 max-h-96 overflow-y-auto"></div></div>
            </div>
        </div>

        <!-- Log Tabs -->
        <div id="monthly-payments-tab" class="tab-content"><div class="bg-white p-4 sm:p-6 rounded-lg shadow-md"><h2 class="text-2xl font-bold mb-4">Monthly Payment Log</h2><div class="overflow-x-auto"><table id="monthly-log-table" class="w-full"></table></div></div></div>
        <div id="extra-payments-tab" class="tab-content"><div class="bg-white p-4 sm:p-6 rounded-lg shadow-md"><h2 class="text-2xl font-bold mb-4">Extra Payment Log</h2><div class="overflow-x-auto"><table id="extra-log-table" class="w-full"></table></div></div></div>
        <div id="expenses-tab" class="tab-content"><div class="bg-white p-4 sm:p-6 rounded-lg shadow-md"><h2 class="text-2xl font-bold mb-4">Expenses Log</h2><div class="overflow-x-auto"><table id="expenses-log-table" class="w-full"></table></div></div></div>

        <!-- Members Tab -->
        <div id="members-tab" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow-md max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-center">Manage Members</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Add New Member</h3>
                        <form id="add-member-form" class="space-y-4">
                            <div>
                                <label for="member-name" class="block text-sm font-medium text-gray-700">Member Name</label>
                                <input type="text" id="member-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., John Doe">
                            </div>
                            <div>
                                <label for="member-email" class="block text-sm font-medium text-gray-700">Member Email</label>
                                <input type="email" id="member-email" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., john.doe@example.com">
                            </div>
                            <div>
                                <label for="joining-date" class="block text-sm font-medium text-gray-700">Joining Date</label>
                                <input type="date" id="joining-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Add Member</button>
                        </form>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Existing Members</h3>
                        <div id="members-container" class="overflow-x-auto">
                             <table id="members-table" class="w-full"></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4">Settings</h2>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto text-center"><h3 id="modal-title" class="text-xl font-bold mb-4"></h3><p id="modal-message"></p><button id="modal-close" class="mt-6 w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Close</button></div></div>
    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto text-center"><h3 id="confirm-title" class="text-xl font-bold mb-4">Are you sure?</h3><p id="confirm-message"></p><div class="mt-6 flex justify-center space-x-4"><button id="confirm-cancel" class="w-full bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">Cancel</button><button id="confirm-ok" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">Confirm</button></div></div></div>

    <script>
        // --- GLOBAL VARIABLES ---
        let monthlyChart = null;
        let appData = {};
        const API_ENDPOINT = 'data.php';
        const MONTH_NAMES = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const today = new Date("2025-07-24T23:40:00");
        const currentMonthIndex = today.getMonth();
        const currentMonthName = MONTH_NAMES[currentMonthIndex];
        const prevMonthName = MONTH_NAMES[currentMonthIndex - 1];

        // --- DATA HANDLING ---
        async function loadData() {
            const loader = document.getElementById('loader');
            loader.classList.add('active');
            try {
                const response = await fetch(`${API_ENDPOINT}?_=${new Date().getTime()}`); // Cache-busting
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                appData = await response.json();
                renderAll();
            } catch (error) {
                console.error("Failed to load data:", error);
                showModal('Error', 'Could not load data from the server.');
            } finally {
                loader.classList.remove('active');
            }
        }

        async function sendAction(action, payload) {
            const loader = document.getElementById('loader');
            loader.querySelector('div').textContent = 'Saving Data...';
            loader.classList.add('active');
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, payload })
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                await loadData(); // Reload data from server to ensure sync
                return true;
            } catch (error) {
                console.error(`Failed to perform action '${action}':`, error);
                showModal('Error', `Could not save data: ${error.message}`);
                return false;
            } finally {
                loader.querySelector('div').textContent = 'Loading Data...';
                loader.classList.remove('active');
            }
        }

        // --- UI & DOM MANIPULATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('payment-type').addEventListener('change', togglePaymentFields);
            document.getElementById('payment-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('admin-event-form').addEventListener('submit', handleAdminEventSubmit);
            document.getElementById('add-member-form').addEventListener('submit', handleAddMemberSubmit);
            document.getElementById('add-expense-form').addEventListener('submit', handleAddExpenseSubmit);
            document.getElementById('monthly-fees-form').addEventListener('submit', handleUpdateAllMonthlyFees);
            document.getElementById('report-month-filter').addEventListener('change', (e) => renderMemberPaymentReport(e.target.value));
            document.getElementById('modal-close').addEventListener('click', () => document.getElementById('message-modal').classList.remove('active'));
            document.getElementById('member-list').addEventListener('click', handleMemberListClick);
            ['monthly-member-name', 'month'].forEach(id => document.getElementById(id).addEventListener('change', showMonthlyPaymentHistory));
            ['extra-member-name', 'extra-payment-for'].forEach(id => document.getElementById(id).addEventListener('change', showExtraPaymentHistory));
            $('#expenses-log-table').on('click', '.edit-expense-btn', handleEditExpenseClick);
            $('#expenses-log-table').on('click', '.save-expense-btn', handleSaveExpenseClick);
            $('#expenses-log-table').on('click', '.delete-expense-btn', handleDeleteExpenseClick);
            $('#event-list').on('click', '.edit-event-btn', handleEditEventClick);
            $('#event-list').on('click', '.save-event-btn', handleSaveEventClick);
            $('#event-list').on('click', '.delete-event-btn', handleDeleteEventClick);
            $('#monthly-log-table').on('click', '.edit-monthly-payment-btn', handleEditMonthlyPaymentClick);
            $('#monthly-log-table').on('click', '.save-monthly-payment-btn', handleSaveMonthlyPaymentClick);
            $('#monthly-log-table').on('click', '.delete-monthly-payment-btn', handleDeleteMonthlyPaymentClick);
            $('#extra-log-table').on('click', '.edit-extra-payment-btn', handleEditExtraPaymentClick);
            $('#extra-log-table').on('click', '.save-extra-payment-btn', handleSaveExtraPaymentClick);
            $('#extra-log-table').on('click', '.delete-extra-payment-btn', handleDeleteExtraPaymentClick);
        }

        function handleEditExtraPaymentClick() {
            const row = $(this).closest('tr');
            row.find('td').each(function(index) {
                if (index === 3) { // Amount Paid column
                    const text = $(this).text();
                    $(this).html(`<input type="text" value="${text}" class="border p-1 w-full">`);
                }
            });
            row.find('.edit-extra-payment-btn').addClass('hidden');
            row.find('.delete-extra-payment-btn').addClass('hidden');
            row.find('.save-extra-payment-btn').removeClass('hidden');
        }

        async function handleSaveExtraPaymentClick() {
            const row = $(this).closest('tr');
            const index = $(this).data('index');
            const amountPaid = parseFloat(row.find('input').eq(0).val().replace(/[^0-9.-]+/g,""));

            const success = await sendAction('editExtraPayment', { index, amountPaid });
            if (success) {
                showModal('Success', 'Extra payment updated successfully.');
            }
        }

        function handleDeleteExtraPaymentClick() {
            const index = $(this).data('index');
            showConfirmModal('Delete Extra Payment', 'Are you sure you want to delete this payment?', async () => {
                const success = await sendAction('deleteExtraPayment', { index });
                if (success) {
                    showModal('Success', 'Extra payment deleted successfully.');
                }
            });
        }

        function handleEditMonthlyPaymentClick() {
            const row = $(this).closest('tr');
            row.find('td').each(function(index) {
                if (index === 3) { // Amount Paid column
                    const text = $(this).text();
                    $(this).html(`<input type="text" value="${text}" class="border p-1 w-full">`);
                }
            });
            row.find('.edit-monthly-payment-btn').addClass('hidden');
            row.find('.delete-monthly-payment-btn').addClass('hidden');
            row.find('.save-monthly-payment-btn').removeClass('hidden');
        }

        async function handleSaveMonthlyPaymentClick() {
            const row = $(this).closest('tr');
            const index = $(this).data('index');
            const amountPaid = parseFloat(row.find('input').eq(0).val().replace(/[^0-9.-]+/g,""));

            const success = await sendAction('editMonthlyPayment', { index, amountPaid });
            if (success) {
                showModal('Success', 'Monthly payment updated successfully.');
            }
        }

        function handleDeleteMonthlyPaymentClick() {
            const index = $(this).data('index');
            showConfirmModal('Delete Monthly Payment', 'Are you sure you want to delete this payment?', async () => {
                const success = await sendAction('deleteMonthlyPayment', { index });
                if (success) {
                    showModal('Success', 'Monthly payment deleted successfully.');
                }
            });
        }

        function handleEditEventClick() {
            const container = $(this).closest('.flex');
            const name = container.find('p.font-semibold').text();
            const amount = parseFloat(container.find('p.text-xs').text().replace(/[^0-9.-]+/g,""));
            container.find('div').eq(0).html(`
                <input type="text" value="${name}" class="border p-1 w-full event-name-input">
                <input type="number" value="${amount}" class="border p-1 w-full event-amount-input">
            `);
            container.find('.edit-event-btn').addClass('hidden');
            container.find('.delete-event-btn').addClass('hidden');
            container.find('.save-event-btn').removeClass('hidden');
        }

        async function handleSaveEventClick() {
            const container = $(this).closest('.flex');
            const index = $(this).data('index');
            const name = container.find('.event-name-input').val();
            const amount = parseFloat(container.find('.event-amount-input').val());
            const success = await sendAction('editEvent', { index, event: { name, amount } });
            if (success) {
                showModal('Success', 'Event updated successfully.');
            }
        }

        function handleDeleteEventClick() {
            const index = $(this).data('index');
            showConfirmModal('Delete Event', 'Are you sure you want to delete this event?', async () => {
                const success = await sendAction('deleteEvent', { index });
                if (success) {
                    showModal('Success', 'Event deleted successfully.');
                }
            });
        }

        function handleEditExpenseClick() {
            const row = $(this).closest('tr');
            row.find('td').each(function(index) {
                if (index < 4) {
                    const text = $(this).text();
                    $(this).html(`<input type="text" value="${text}" class="border p-1 w-full">`);
                }
            });
            row.find('.edit-expense-btn').addClass('hidden');
            row.find('.delete-expense-btn').addClass('hidden');
            row.find('.save-expense-btn').removeClass('hidden');
        }

        async function handleSaveExpenseClick() {
            const row = $(this).closest('tr');
            const index = $(this).data('index');
            const originalExpense = appData.expenses[index];
            const updatedExpense = {
                date: row.find('input').eq(0).val(),
                name: row.find('input').eq(1).val(),
                amount: parseFloat(row.find('input').eq(2).val().replace(/[^0-9.-]+/g,"")),
                comment: row.find('input').eq(3).val()
            };

            const success = await sendAction('editExpense', { index, updatedExpense });
            if (success) {
                showModal('Success', 'Expense updated successfully.');
            }
        }

        function handleDeleteExpenseClick() {
            const index = $(this).data('index');
            showConfirmModal('Delete Expense', 'Are you sure you want to delete this expense?', async () => {
                const success = await sendAction('deleteExpense', { index });
                if (success) {
                    showModal('Success', 'Expense deleted successfully.');
                }
            });
        }

        function openTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-link').forEach(link => link.className = link.className.replace(' border-blue-500 text-blue-600 bg-white', ' text-gray-500'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.className += ' border-blue-500 text-blue-600 bg-white';
            if(tabName === 'dashboard-tab') { renderDashboard(); }
        }

        function togglePaymentFields() { /* ... unchanged ... */ }
        function populateAllDropdowns() { /* ... unchanged ... */ }
        function showModal(title, message) { /* ... unchanged ... */ }

        function showConfirmModal(title, message, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            modal.querySelector('#confirm-title').textContent = title;
            modal.querySelector('#confirm-message').textContent = message;

            const confirmBtn = modal.querySelector('#confirm-ok');
            const cancelBtn = modal.querySelector('#confirm-cancel');

            const confirmHandler = () => {
                modal.classList.remove('active');
                onConfirm();
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            const cancelHandler = () => {
                modal.classList.remove('active');
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);

            modal.classList.add('active');
        }

        // --- DATA RENDERING & DASHBOARD ---
        function renderAll() {
            if (!appData.members) return;
            populateAllDropdowns();
            renderAdminMemberList();
            renderAdminEventList();
            renderMonthlyPaymentsTable();
            renderExtraPaymentsTable();
            renderExpensesTable();
            renderMonthlyFeesAdmin();
            renderDashboard();
            renderMemberPaymentReport(document.getElementById('report-month-filter').value || currentMonthName);
            renderMembersTable();
        }

        function renderMembersTable() {
            const { members } = appData;
            const tableData = members.map((member, index) => {
                const status = member.status || 'active';
                const statusClass = status === 'active' ? 'text-green-500' : 'text-red-500';
                const monthOptions = MONTH_NAMES.map(m => `<option value="${m}" ${member.deactivation_month === m ? 'selected' : ''}>${m}</option>`).join('');

                return [
                    `<input type="text" value="${member.name}" class="border-none bg-transparent" readonly>`,
                    `<input type="email" value="${member.email}" class="border-none bg-transparent" readonly>`,
                    `<span class="${statusClass}">${status}</span>`,
                    `<select class="deactivation-month-select border p-1 rounded ${status === 'active' ? 'hidden' : ''}" data-index="${index}">${monthOptions}</select>`,
                    `<button class="edit-member-btn bg-blue-500 text-white px-2 py-1 rounded">Edit</button>
                     <button class="save-member-btn bg-green-500 text-white px-2 py-1 rounded hidden">Save</button>
                     <button class="toggle-status-btn bg-yellow-500 text-white px-2 py-1 rounded ml-2" data-index="${index}">${status === 'active' ? 'Deactivate' : 'Activate'}</button>`
                ];
            });

            renderDataTable('members-table', [
                { title: "Name" }, { title: "Email" }, { title: "Status" }, { title: "Deactivation Month" }, { title: "Actions" }
            ], tableData);

            $('#members-table').on('click', '.edit-member-btn', function() {
                const row = $(this).closest('tr');
                row.find('input').prop('readonly', false).addClass('border');
                row.find('.edit-member-btn').addClass('hidden');
                row.find('.save-member-btn').removeClass('hidden');
            });

            $('#members-table').on('click', '.save-member-btn', function() {
                const row = $(this).closest('tr');
                const name = row.find('input').eq(0).val();
                const email = row.find('input').eq(1).val();
                const originalName = appData.members[row.index()].name;

                sendAction('editMember', { originalName, name, email }).then(success => {
                    if (success) {
                        row.find('input').prop('readonly', true).removeClass('border');
                        row.find('.edit-member-btn').removeClass('hidden');
                        row.find('.save-member-btn').addClass('hidden');
                        showModal('Success', 'Member updated successfully.');
                    }
                });
            });

            $('#members-table').on('click', '.toggle-status-btn', function() {
                const index = $(this).data('index');
                const member = appData.members[index];
                const newStatus = member.status === 'active' ? 'inactive' : 'active';
                sendAction('toggleMemberStatus', { index, status: newStatus });
            });

            $('#members-table').on('change', '.deactivation-month-select', function() {
                const index = $(this).data('index');
                const month = $(this).val();
                sendAction('setDeactivationMonth', { index, month });
            });
        }

        function formatCurrency(amount) { /* ... unchanged ... */ }
        function getPendingForMonth(monthName) { /* ... unchanged ... */ }
        function renderDashboard() { /* ... unchanged ... */ }

        function renderDataTable(tableId, columns, data, options = {}) {
            const table = $(`#${tableId}`);
            if ($.fn.DataTable.isDataTable(table)) {
                table.DataTable().destroy();
                table.empty(); // Clear headers and body
            }
            table.DataTable({
                columns,
                data,
                responsive: true,
                ...options
            });
        }

        function calculateProratedFee(joiningDate, monthlyFee, monthName) {
            const joining = new Date(joiningDate);
            const monthIndex = MONTH_NAMES.indexOf(monthName);
            const year = today.getFullYear();

            if (joining.getFullYear() !== year || joining.getMonth() !== monthIndex) {
                return monthlyFee;
            }

            const fridays = [];
            const d = new Date(year, monthIndex, 1);
            while (d.getMonth() === monthIndex) {
                if (d.getDay() === 5) { // Friday
                    fridays.push(new Date(d));
                }
                d.setDate(d.getDate() + 1);
            }

            const fridaysAfterJoining = fridays.filter(friday => friday >= joining).length;
            const pricePerFriday = monthlyFee / fridays.length;
            return fridaysAfterJoining * pricePerFriday;
        }

        function renderMemberPaymentReport(month) {
            const { members, monthlyPaymentDetails, monthlyPayments } = appData;
            const monthInfo = monthlyPayments.find(p => p.month === month);
            const monthDue = monthInfo ? monthInfo.amount : 0;

            const reportData = members.map(member => {
                const dueForMember = calculateProratedFee(member.joining_date, monthDue, month);
                const payment = monthlyPaymentDetails.find(p => p.memberName === member.name && p.month === month);
                const paid = payment ? payment.amountPaid : 0;
                const remaining = dueForMember - paid;
                let status, color;
                if (paid >= dueForMember) { status = 'Fully Paid'; color = 'bg-green-100 text-green-800'; }
                else if (paid > 0) { status = 'Partially Paid'; color = 'bg-yellow-100 text-yellow-800'; }
                else { status = 'Pending'; color = 'bg-red-100 text-red-800'; }
                return [member.name, formatCurrency(dueForMember), formatCurrency(paid), formatCurrency(remaining), `<span class="px-2 py-1 rounded-full text-xs font-semibold ${color}">${status}</span>`];
            });

            renderDataTable('report-table', [
                { title: "Member Name" }, { title: "Total Due" }, { title: "Amount Paid" }, { title: "Remaining" }, { title: "Status" }
            ], reportData);
        }

        function renderMonthlyPaymentsTable() {
            const details = appData.monthlyPaymentDetails || [];
            const data = details.map((p, index) => {
                const statusClass = p.status.startsWith('Fully') ? 'text-green-600' : p.status.startsWith('Partially') ? 'text-yellow-600' : 'text-red-600';
                return [
                    new Date(p.date).toLocaleDateString(),
                    p.memberName,
                    p.month,
                    formatCurrency(p.amountPaid),
                    formatCurrency(p.totalAmountDue),
                    formatCurrency(p.remainingAmount),
                    `<span class="font-semibold ${statusClass}">${p.status}</span>`,
                    p.paidVia,
                    `<button class="edit-monthly-payment-btn bg-blue-500 text-white px-2 py-1 rounded" data-index="${index}">Edit</button>
                     <button class="delete-monthly-payment-btn bg-red-500 text-white px-2 py-1 rounded" data-index="${index}">Delete</button>
                     <button class="save-monthly-payment-btn bg-green-500 text-white px-2 py-1 rounded hidden" data-index="${index}">Save</button>`
                ];
            });
            renderDataTable('monthly-log-table', [
                { title: "Date" }, { title: "Member" }, { title: "Month" }, { title: "Paid" }, { title: "Due" }, { title: "Remaining" }, { title: "Status" }, { title: "Paid Via" }, { title: "Actions" }
            ], data);
        }

        function renderExtraPaymentsTable() {
            const details = appData.extraPaymentDetails || [];
            const data = details.map((p, index) => {
                const statusClass = p.status.startsWith('Fully') ? 'text-green-600' : p.status.startsWith('Partially') ? 'text-yellow-600' : 'text-red-600';
                return [
                    new Date(p.date).toLocaleDateString(),
                    p.memberName,
                    p.extraPaymentFor,
                    formatCurrency(p.paidAmount),
                    formatCurrency(p.totalAmountDue),
                    formatCurrency(p.remainingAmount),
                    `<span class="font-semibold ${statusClass}">${p.status}</span>`,
                    `<button class="edit-extra-payment-btn bg-blue-500 text-white px-2 py-1 rounded" data-index="${index}">Edit</button>
                     <button class="delete-extra-payment-btn bg-red-500 text-white px-2 py-1 rounded" data-index="${index}">Delete</button>
                     <button class="save-extra-payment-btn bg-green-500 text-white px-2 py-1 rounded hidden" data-index="${index}">Save</button>`
                ];
            });
            renderDataTable('extra-log-table', [
                { title: "Date" }, { title: "Member" }, { title: "For" }, { title: "Paid" }, { title: "Due" }, { title: "Remaining" }, { title: "Status" }, { title: "Actions" }
            ], data);
        }

        function renderExpensesTable() {
            const expenses = appData.expenses || [];
            const data = expenses.map((e, index) => [
                new Date(e.date).toLocaleDateString(),
                e.name,
                formatCurrency(e.amount),
                e.comment,
                `<button class="edit-expense-btn bg-blue-500 text-white px-2 py-1 rounded" data-index="${index}">Edit</button>
                 <button class="delete-expense-btn bg-red-500 text-white px-2 py-1 rounded" data-index="${index}">Delete</button>
                 <button class="save-expense-btn bg-green-500 text-white px-2 py-1 rounded hidden" data-index="${index}">Save</button>`
            ]);
            renderDataTable('expenses-log-table', [
                { title: "Date" }, { title: "Expense" }, { title: "Amount" }, { title: "Comment" }, { title: "Actions" }
            ], data);
        }

        function renderAdminMemberList() {
            const container = document.getElementById('member-list');
            container.innerHTML = appData.members.map(member => `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-md">
                    <div>
                        <p class="font-semibold">${member.name}</p>
                        <p class="text-xs text-gray-500">${member.email}</p>
                    </div>
                    <button data-name="${member.name}" class="remove-member-btn text-red-500 hover:text-red-700 font-bold">Remove</button>
                </div>
            `).join('');
        }

        function renderAdminEventList() {
            const container = document.getElementById('event-list');
            container.innerHTML = appData.extraPayments.map((event, index) => `
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-md">
                    <div>
                        <p class="font-semibold">${event.name}</p>
                        <p class="text-xs text-gray-500">${formatCurrency(event.amount)}</p>
                    </div>
                    <div>
                        <button data-index="${index}" class="edit-event-btn text-blue-500 hover:text-blue-700 font-bold mr-2">Edit</button>
                        <button data-index="${index}" class="delete-event-btn text-red-500 hover:text-red-700 font-bold">Delete</button>
                        <button data-index="${index}" class="save-event-btn text-green-500 hover:text-green-700 font-bold hidden">Save</button>
                    </div>
                </div>
            `).join('');
        }

        function renderMonthlyFeesAdmin() { /* ... unchanged ... */ }

        // --- FORM HANDLING & LOGIC ---
        async function handleUpdateAllMonthlyFees(e) { /* ... unchanged, but now calls sendAction ... */ }
        async function handleAddExpenseSubmit(e) { /* ... unchanged, but now calls sendAction ... */ }
        async function handleFormSubmit(e) { /* ... unchanged ... */ }
        async function handleAdminEventSubmit(e) { /* ... unchanged, but now calls sendAction ... */ }
        async function processMonthlyPayment() { /* ... unchanged, but now calls sendAction ... */ }
        async function processExtraPayment() { /* ... unchanged, but now calls sendAction ... */ }
        function showMonthlyPaymentHistory() { /* ... unchanged ... */ }
        function showExtraPaymentHistory() { /* ... unchanged ... */ }

        async function handleAddMemberSubmit(e) {
            e.preventDefault();
            const nameInput = document.getElementById('member-name');
            const emailInput = document.getElementById('member-email');
            const joiningDateInput = document.getElementById('joining-date');
            const name = nameInput.value.trim();
            const email = emailInput.value.trim();
            const joiningDate = joiningDateInput.value;
            if (!name || !email || !joiningDate) { showModal('Error', 'Please enter name, email and joining date.'); return; }
            if (appData.members.some(m => m.name.toLowerCase() === name.toLowerCase())) { showModal('Error', 'A member with this name already exists.'); return; }

            const success = await sendAction('addMember', { name, email, joining_date: joiningDate });
            if (success) {
                showModal('Success', `Member "${name}" added successfully.`);
                e.target.reset();
            }
        }

        function handleMemberListClick(e) {
            if (e.target.classList.contains('remove-member-btn')) {
                const name = e.target.dataset.name;
                showConfirmModal('Remove Member', `Are you sure you want to remove ${name}? This action cannot be undone.`, async () => {
                    const success = await sendAction('removeMember', { name });
                    if (success) {
                        showModal('Success', `Member "${name}" has been removed.`);
                    }
                });
            }
        }

        // --- Unchanged Functions (for brevity, but still present in the full script) ---
        // These functions are mostly the same but now use `sendAction` instead of modifying `appData` directly and calling `saveData`.
        // The logic inside them remains the same.
        togglePaymentFields = () => { const type = document.getElementById('payment-type').value; document.getElementById('monthly-payment-fields').classList.toggle('hidden', type !== 'monthly'); document.getElementById('extra-payment-fields').classList.toggle('hidden', type !== 'extra'); };
        populateAllDropdowns = () => { const memberOptions = '<option value="">Select Member</option>' + appData.members.map(m => `<option value="${m.name}">${m.name}</option>`).join(''); document.getElementById('monthly-member-name').innerHTML = memberOptions; document.getElementById('extra-member-name').innerHTML = memberOptions; document.getElementById('extra-payment-for').innerHTML = '<option value="">Select Event</option>' + appData.extraPayments.map(e => `<option value="${e.name}">${e.name}</option>`).join(''); const monthOptions = appData.monthlyPayments.map(p => `<option value="${p.month}">${p.month}</option>`).join(''); document.getElementById('month').innerHTML = monthOptions; document.getElementById('report-month-filter').innerHTML = monthOptions; document.getElementById('report-month-filter').value = currentMonthName; };
        showModal = (title, message) => { document.getElementById('modal-title').textContent = title; document.getElementById('modal-message').textContent = message; document.getElementById('message-modal').classList.add('active'); };
        formatCurrency = (amount) => amount.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        getPendingForMonth = (monthName) => {
            const { members, monthlyPaymentDetails, monthlyPayments } = appData;
            const monthDueAmount = monthlyPayments.find(p => p.month === monthName)?.amount || 0;
            const monthIndex = MONTH_NAMES.indexOf(monthName);

            const activeMembersForMonth = members.filter(member => {
                if (member.status === 'inactive') {
                    const deactivationMonthIndex = MONTH_NAMES.indexOf(member.deactivation_month);
                    return monthIndex < deactivationMonthIndex;
                }
                return true;
            });

            const totalMonthDue = monthDueAmount * activeMembersForMonth.length;
            const totalMonthCollected = monthlyPaymentDetails.filter(p => p.month === monthName).reduce((sum, p) => sum + p.amountPaid, 0);
            return totalMonthDue - totalMonthCollected;
        };
        renderDashboard = () => { const { members, monthlyPaymentDetails, extraPaymentDetails, monthlyPayments, expenses } = appData; document.getElementById('total-members').textContent = members.length; const totalCollected = monthlyPaymentDetails.reduce((sum, p) => sum + p.amountPaid, 0) + extraPaymentDetails.reduce((sum, p) => sum + p.paidAmount, 0); document.getElementById('total-collected').textContent = formatCurrency(totalCollected); const totalDueOverall = monthlyPayments.slice(0, currentMonthIndex + 1).reduce((sum, p) => sum + (p.amount * members.length), 0) + extraPaymentDetails.reduce((sum, p) => sum + p.totalAmountDue, 0); const totalPending = totalDueOverall - totalCollected; document.getElementById('total-due').textContent = formatCurrency(totalPending); document.getElementById('june-pending').textContent = formatCurrency(getPendingForMonth(prevMonthName)); document.getElementById('july-pending').textContent = formatCurrency(getPendingForMonth(currentMonthName)); const currentMonthExpenses = expenses.filter(e => new Date(e.date).getMonth() === currentMonthIndex); const expensesListContainer = document.getElementById('monthly-expenses-list'); expensesListContainer.innerHTML = currentMonthExpenses.length === 0 ? '<p class="text-gray-500">No expenses recorded for this month.</p>' : currentMonthExpenses.map(e => `<div class="flex justify-between items-center bg-gray-50 p-2 rounded-md"><div><p class="font-semibold">${e.name}</p><p class="text-xs text-gray-500">${new Date(e.date).toLocaleDateString()}</p></div><p class="font-bold text-red-500">${formatCurrency(e.amount)}</p></div>`).join(''); const monthlyData = monthlyPayments.map(monthInfo => ({ month: monthInfo.month, collected: monthlyPaymentDetails.filter(p => p.month === monthInfo.month).reduce((sum, p) => sum + p.amountPaid, 0), due: monthInfo.amount * members.length })); const ctx = document.getElementById('monthly-collection-chart').getContext('2d'); if (monthlyChart) { monthlyChart.destroy(); } monthlyChart = new Chart(ctx, { type: 'bar', data: { labels: monthlyData.map(d => d.month), datasets: [{ label: 'Collected', data: monthlyData.map(d => d.collected), backgroundColor: 'rgba(75, 192, 192, 0.6)' }, { label: 'Due', data: monthlyData.map(d => d.due), backgroundColor: 'rgba(255, 99, 132, 0.6)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } }); };
        renderMonthlyFeesAdmin = () => { document.getElementById('monthly-fees-list').innerHTML = appData.monthlyPayments.map(p => `<div class="flex items-center justify-between p-2 bg-gray-50 rounded-md"><span class="font-medium">${p.month}</span><input type="number" value="${p.amount}" data-month="${p.month}" class="w-24 p-1 border border-gray-300 rounded-md monthly-fee-input"></div>`).join(''); };
        handleUpdateAllMonthlyFees = async (e) => { e.preventDefault(); const newFees = []; document.querySelectorAll('.monthly-fee-input').forEach(input => { newFees.push({ month: input.dataset.month, amount: parseFloat(input.value) }); }); await sendAction('updateAllFees', newFees); showModal('Success', 'Monthly fees have been updated.'); };
        handleAddExpenseSubmit = async (e) => { e.preventDefault(); const name = document.getElementById('expense-name').value.trim(); const amount = parseFloat(document.getElementById('expense-amount').value); const date = document.getElementById('expense-date').value; const comment = document.getElementById('expense-comment').value.trim(); if (!name || isNaN(amount) || !date) { showModal('Error', 'Please fill all required expense fields.'); return; } await sendAction('addExpense', { name, amount, date, comment }); showModal('Success', 'Expense added successfully.'); e.target.reset(); };
        handleFormSubmit = async (e) => { e.preventDefault(); const type = document.getElementById('payment-type').value; if (type === 'monthly') await processMonthlyPayment(); else if (type === 'extra') await processExtraPayment(); else showModal('Error', 'Please select a payment type.'); };
        handleAdminEventSubmit = async (e) => { e.preventDefault(); const name = document.getElementById('event-name').value.trim(); const amount = parseFloat(document.getElementById('event-amount').value); if (!name || isNaN(amount) || amount <= 0) { showModal('Error', 'Please enter a valid event name and amount.'); return; } await sendAction('addEvent', { name, amount }); showModal('Success', `Event "${name}" added successfully.`); e.target.reset(); };
        processMonthlyPayment = async () => { const memberName = document.getElementById('monthly-member-name').value; const month = document.getElementById('month').value; const amountPaid = parseFloat(document.getElementById('monthly-amount-paid').value); const paidVia = document.getElementById('paid-via').value; if (!memberName || !month || isNaN(amountPaid) || amountPaid <= 0) { showModal('Error', 'Please fill all fields correctly.'); return; } await sendAction('addMonthlyPayment', { memberName, month, amountPaid, paidVia }); showModal('Success', 'Monthly payment recorded!'); document.getElementById('payment-form').reset(); };
        processExtraPayment = async () => { const memberName = document.getElementById('extra-member-name').value; const extraPaymentFor = document.getElementById('extra-payment-for').value; const amountPaid = parseFloat(document.getElementById('extra-amount-paid').value); if (!memberName || !extraPaymentFor || isNaN(amountPaid) || amountPaid <= 0) { showModal('Error', 'Please fill all fields correctly.'); return; } await sendAction('addExtraPayment', { memberName, extraPaymentFor, amountPaid }); showModal('Success', 'Extra payment recorded!'); document.getElementById('payment-form').reset(); };
        showMonthlyPaymentHistory = () => { const memberName = document.getElementById('monthly-member-name').value; const month = document.getElementById('month').value; const historyDiv = document.getElementById('monthly-payment-history'); if (!memberName || !month) { historyDiv.classList.add('hidden'); return; } const entry = appData.monthlyPaymentDetails.find(p => p.memberName === memberName && p.month === month); if (entry) { historyDiv.innerHTML = `<strong>Payment History:</strong> Paid ${formatCurrency(entry.amountPaid)} of ${formatCurrency(entry.totalAmountDue)}. Status: ${entry.status}`; historyDiv.classList.remove('hidden'); } else { historyDiv.classList.add('hidden'); } };
        showExtraPaymentHistory = () => { const memberName = document.getElementById('extra-member-name').value; const extraFor = document.getElementById('extra-payment-for').value; const historyDiv = document.getElementById('extra-payment-history'); if (!memberName || !extraFor) { historyDiv.classList.add('hidden'); return; } const entry = appData.extraPaymentDetails.find(p => p.memberName === memberName && p.extraPaymentFor === extraFor); if (entry) { historyDiv.innerHTML = `<strong>Payment History:</strong> Paid ${formatCurrency(entry.paidAmount)} of ${formatCurrency(entry.totalAmountDue)}. Status: ${entry.status}`; historyDiv.classList.remove('hidden'); } else { historyDiv.classList.add('hidden'); } };

    </script>
</body>
</html>
